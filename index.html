<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="app-title-tag">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶ö‡¶ü‡¶ø ‡¶ó‡¶≤‡ßç‡¶™</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Monetag Master SDK -->
    <script src='//libtl.com/sdk.js' data-zone='10366901' data-sdk='show_10366901'></script>

    <!-- Firebase SDK (Version 8 compatible) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            transition: background-color 0.3s, color 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        /* Night Mode Styles */
        body.night-mode {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .night-mode .bg-white { background-color: #1e293b; }
        .night-mode .text-gray-800 { color: #f1f5f9; }
        .night-mode .text-gray-900 { color: #ffffff; }
        .night-mode .text-gray-500 { color: #94a3b8; }
        .night-mode .border-gray-100 { border-color: #334155; }
        .night-mode .bg-gray-50 { background-color: #334155; }
        .night-mode .hover\:bg-gray-50:hover { background-color: #475569; }
        .night-mode input, .night-mode textarea, .night-mode select {
            background-color: #334155;
            color: white;
            border-color: #475569;
        }

        .hidden { display: none !important; }

        /* Loader Animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Scrollbar Hide */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Pagination Button Styles */
        .page-btn {
            width: 35px; height: 35px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px; font-weight: bold; font-size: 14px;
            cursor: pointer; transition: all 0.2s;
        }
        .page-btn.active { background-color: #2563eb; color: white; border: none; }
        .page-btn.inactive { background-color: white; border: 1px solid #e2e8f0; color: #1e293b; }
        .night-mode .page-btn.inactive { background-color: #1e293b; border-color: #334155; color: #e2e8f0; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-gray-500 animate-pulse">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>

    <!-- Age Verification Modal -->
    <div id="age-gate" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-5 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl max-w-sm text-center shadow-2xl">
            <h2 class="text-2xl font-bold text-red-600 mb-4">‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡ßÄ‡¶ï‡¶∞‡¶£ (18+)</h2>
            <p class="text-gray-600 mb-6">‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∑‡ßü‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶¨‡ßü‡¶∏‡ßç‡¶ï‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßü‡¶∏ ‡¶ï‡¶ø ‡ßß‡ßÆ ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø?</p>
            <button onclick="acceptAgeGate()" class="bg-red-600 text-white px-8 py-3 rounded-full font-bold w-full hover:bg-red-700 transition">‡¶π‡ßç‡¶Ø‡¶æ‡¶Å, ‡¶Ü‡¶Æ‡¶ø ‡ßß‡ßÆ+</button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-5 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm relative shadow-xl">
            <button onclick="document.getElementById('auth-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 text-xl hover:text-red-500">√ó</button>
            <h3 class="text-xl font-bold mb-4 text-center text-gray-800">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ó‡¶á‡¶®</h3>
            <form onsubmit="handleAuth(event)" class="space-y-4">
                <input type="email" id="auth-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤" class="w-full p-3 border rounded-lg bg-gray-50 focus:outline-none focus:border-blue-500 text-gray-800">
                <input type="password" id="auth-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" class="w-full p-3 border rounded-lg bg-gray-50 focus:outline-none focus:border-blue-500 text-gray-800">
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">‡¶≤‡¶ó‡¶á‡¶®</button>
            </form>
        </div>
    </div>

    <!-- ================= HOME SCREEN ================= -->
    <div id="home-screen">
        <!-- Header -->
        <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-gray-100 px-4 py-3 flex justify-between items-center">
            <h1 id="app-nav-title" class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600 cursor-pointer" onclick="window.location.reload()">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶ö‡¶ü‡¶ø ‡¶ó‡¶≤‡ßç‡¶™</h1>
            <div class="flex items-center gap-3">
                <button onclick="toggleNightMode()" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition">üåô</button>
                <button onclick="handleProfileClick()" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition">üë§</button>
            </div>
        </header>

        <!-- Search & Filter -->
        <div class="p-4 space-y-4">
            <input type="text" id="search-input" onkeyup="handleSearch()" placeholder="‡¶ó‡¶≤‡ßç‡¶™ ‡¶¨‡¶æ ‡¶≤‡ßá‡¶ñ‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full p-3 rounded-xl border border-gray-200 bg-white shadow-sm focus:outline-none focus:border-blue-500 text-gray-800 transition">

            <div id="category-filters" class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                <!-- Categories injected here -->
            </div>
        </div>

        <!-- Stories List -->
        <div id="stories-list" class="px-4 space-y-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Stories injected here -->
        </div>

        <!-- No Data Message -->
        <div id="no-data-msg" class="hidden text-center py-20 text-gray-400">
            <p class="text-4xl mb-2">üòû</p>
            <p>‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡¶≤‡ßç‡¶™ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p>
        </div>

        <!-- Pagination -->
        <div id="pagination-container" class="py-8 flex justify-center items-center gap-2 flex-wrap px-4 pb-20"></div>

        <!-- Admin Access Float Button -->
        <button id="admin-indicator" onclick="showScreen('admin-panel'); renderAdminListUI();" class="hidden fixed bottom-6 right-6 bg-purple-600 text-white p-4 rounded-full shadow-lg font-bold z-30 hover:scale-105 transition">
            ‚öôÔ∏è ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤
        </button>
    </div>

    <!-- ================= READING SCREEN ================= -->
    <div id="reading-screen" class="hidden min-h-screen bg-white pb-20">
        <!-- Reading Header -->
        <div class="sticky top-0 bg-white/95 backdrop-blur border-b p-3 flex justify-between items-center z-10 shadow-sm">
            <button onclick="closeReadingScreen()" class="text-blue-600 font-bold px-2 py-1 flex items-center gap-1 hover:bg-blue-50 rounded">
                <span>‚Üê</span> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®
            </button>

            <div class="flex items-center gap-2">
                <button id="read-fav-btn" onclick="toggleReadScreenFavorite()" class="p-2 text-xl border rounded bg-gray-50 hover:bg-gray-100 transition mr-2">ü§ç</button>
                <span class="text-xs text-gray-400 mr-1 hidden sm:inline">‡¶´‡¶®‡ßç‡¶ü:</span>
                <button onclick="changeFontSize('decrease')" class="bg-gray-100 border px-3 py-1 rounded text-sm font-bold active:bg-gray-200 text-black">A-</button>
                <button onclick="changeFontSize('increase')" class="bg-gray-100 border px-3 py-1 rounded text-sm font-bold active:bg-gray-200 text-black">A+</button>
            </div>
        </div>

        <div class="p-5 max-w-3xl mx-auto">
            <h1 id="read-title" class="text-2xl md:text-3xl font-bold mb-3 text-gray-900 leading-snug">‡¶ó‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</h1>

            <div class="flex flex-wrap justify-between items-center text-sm text-gray-500 mb-6 border-b pb-4 gap-2">
                <div class="flex gap-3">
                    <span id="read-meta-author" class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100">‡¶≤‡ßá‡¶ñ‡¶ï</span> 
                    <span id="read-meta-cat" class="bg-gray-100 px-2 py-0.5 rounded border border-gray-200 text-gray-600">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</span>
                </div>
                <div id="read-meta-views" class="flex items-center gap-1 font-medium bg-gray-50 px-2 py-0.5 rounded">üëÅÔ∏è 0</div>
            </div>

            <div id="read-content" class="text-gray-800 leading-relaxed whitespace-pre-wrap font-medium select-none" style="font-size: 18px;">
                <!-- Content will be injected here with ads -->
            </div>

            <div class="mt-12 pt-6 border-t border-gray-100">
                <button onclick="shareStory()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3.5 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2 transition-transform active:scale-95">
                    <span>üîó</span> ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>

    <!-- ================= ADMIN PANEL ================= -->
    <div id="admin-panel" class="hidden min-h-screen bg-gray-50 pb-20">
        <div class="bg-white p-4 shadow-sm flex justify-between items-center sticky top-0 z-20 border-b">
            <h2 class="text-xl font-bold text-gray-800">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
            <div class="flex gap-2">
                <button onclick="showScreen('home-screen')" class="px-4 py-2 bg-gray-200 rounded-lg text-sm text-black hover:bg-gray-300">‡¶π‡ßã‡¶Æ</button>
                <button onclick="logoutAdmin()" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg text-sm font-bold hover:bg-red-200">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
            </div>
        </div>

        <div class="p-4 max-w-4xl mx-auto space-y-6">
            <!-- Settings Card -->
            <div class="bg-white p-5 rounded-xl shadow-sm border">
                <h3 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2">‚öôÔ∏è ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
                <div class="grid gap-4 md:grid-cols-2">
                    <input id="set-app-name" type="text" placeholder="‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="p-2 border rounded text-black">
                    <input id="set-ad-link" type="text" placeholder="Monetag Direct Link (URL)" class="p-2 border rounded text-black">
                </div>
                <button onclick="updateSettings()" class="mt-4 bg-gray-800 text-white px-6 py-2 rounded-lg text-sm hover:bg-gray-900">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>

            <!-- Category Management -->
            <div class="bg-white p-5 rounded-xl shadow-sm border">
                <h3 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2">üìÇ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
                <div class="flex gap-2 mb-4">
                    <input id="new-cat-input" type="text" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶æ‡¶Æ" class="flex-1 p-2 border rounded text-black focus:outline-none focus:border-blue-500">
                    <button onclick="addCategory()" class="bg-green-600 text-white px-4 rounded font-bold hover:bg-green-700 active:bg-green-800">+</button>
                </div>
                <div id="admin-cat-list" class="flex flex-wrap gap-2">
                    <!-- Categories will load here -->
                </div>
            </div>

            <!-- Story Form -->
            <div class="bg-white p-5 rounded-xl shadow-sm border">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 id="form-mode-title" class="font-bold text-lg text-gray-800">üìù ‡¶ó‡¶≤‡ßç‡¶™ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</h3>
                    <button onclick="resetForm()" class="text-xs text-blue-600 underline hover:text-blue-800">‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button>
                </div>

                <form id="story-form" class="space-y-4">
                    <input type="hidden" id="edit-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="story-title" required type="text" placeholder="‡¶ó‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="p-3 border rounded text-black w-full focus:border-blue-500 outline-none">
                        <input id="story-author" required type="text" placeholder="‡¶≤‡ßá‡¶ñ‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="p-3 border rounded text-black w-full focus:border-blue-500 outline-none">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <select id="story-category-select" class="p-3 border rounded bg-white text-black w-full"></select>
                        <select id="story-status" class="p-3 border rounded bg-white text-black w-full">
                            <option value="Published">Published</option>
                            <option value="Draft">Draft</option>
                        </select>
                    </div>

                    <textarea id="story-summary" rows="2" placeholder="‡¶õ‡ßã‡¶ü ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™ (Summary - ‡¶Ø‡¶æ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá)" class="w-full p-3 border rounded text-black focus:border-blue-500 outline-none"></textarea>
                    <textarea id="story-content" required rows="10" placeholder="‡¶Æ‡ßÇ‡¶≤ ‡¶ó‡¶≤‡ßç‡¶™ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="w-full p-3 border rounded text-black focus:border-blue-500 outline-none"></textarea>

                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </form>
            </div>

            <!-- Admin Story List (Edit/Delete) -->
            <div class="bg-white p-5 rounded-xl shadow-sm border">
                <h3 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2">‡¶∏‡¶¨ ‡¶ó‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
                <div id="admin-story-list" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONFIGURATION ---
        const ADMIN_EMAIL = "bcg332006@gmail.com";
        const DEFAULT_CATS = ['‡¶∞‡ßã‡¶Æ‡¶æ‡¶®‡ßç‡¶ü‡¶ø‡¶ï', '‡¶™‡¶∞‡¶ï‡ßÄ‡ßü‡¶æ', '‡¶á‡¶®‡¶∏‡ßá‡¶∏‡ßç‡¶ü', '‡¶≠‡¶æ‡¶¨‡¶ø', '‡¶≤‡ßá‡¶∏‡¶¨‡¶ø‡ßü‡¶æ‡¶®', '‡¶´‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü‡¶æ‡¶∏‡¶ø', '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø', '‡¶Æ‡¶æ ‡¶õ‡ßá‡¶≤‡ßá'];

        const firebaseConfig = {
            apiKey: "AIzaSyA4gqOdRYydzPOR7a8brxBy2Bs49MtVqJw",
            authDomain: "bangla-f8386.firebaseapp.com",
            projectId: "bangla-f8386",
            storageBucket: "bangla-f8386.firebasestorage.app",
            messagingSenderId: "213257434534",
            appId: "1:213257434534:web:3748a963d1f4e299e64b67"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // State Variables
        let appSettings = { name: "‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶ö‡¶ü‡¶ø ‡¶ó‡¶≤‡ßç‡¶™", adLink: "https://google.com" };
        let categories = [...DEFAULT_CATS]; 
        let stories = [];
        let currentUser = null;
        let currentFontSize = 18; 
        let currentStoryId = null; 
        let initialUrlCheckDone = false; 

        // --- PAGINATION VARIABLES ---
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentFilteredList = [];

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            // Check Age Gate
            if(!localStorage.getItem('age_verified')) {
                document.getElementById('age-gate').classList.remove('hidden');
            }

            renderCategoriesUI();

            // Check Night Mode
            if(localStorage.getItem('nightMode') === 'true') {
                document.body.classList.add('night-mode');
            }

            // Auth Listener
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if(user && user.email === ADMIN_EMAIL) {
                    document.getElementById('admin-indicator').classList.remove('hidden');
                } else {
                    document.getElementById('admin-indicator').classList.add('hidden');
                    if(!document.getElementById('admin-panel').classList.contains('hidden')) {
                        showScreen('home-screen');
                    }
                }
            });

            // Load Settings
            db.collection('config').doc('app_settings').onSnapshot(doc => {
                if(doc.exists) {
                    appSettings = doc.data();
                    updateAppMeta();
                }
                removeLoader();
            }, err => {
                console.error("Settings load error:", err);
                removeLoader();
            });

            // Load Categories
            db.collection('config').doc('categories').onSnapshot(doc => {
                if(doc.exists && doc.data().list && doc.data().list.length > 0) {
                    categories = doc.data().list;
                }
                renderCategoriesUI();
            });

            // Load Stories
            const storyLoaderTimeout = setTimeout(() => removeLoader(), 5000); 

            db.collection('stories').orderBy('updatedAt', 'desc').onSnapshot(snap => {
                clearTimeout(storyLoaderTimeout);
                stories = snap.docs.map(d => ({id: d.id, ...d.data()}));

                applyFilters(); 

                if(currentUser && currentUser.email === ADMIN_EMAIL) renderAdminListUI();

                // Check URL for shared story ID
                if (!initialUrlCheckDone && stories.length > 0) {
                    const params = new URLSearchParams(window.location.search);
                    const sharedId = params.get('id') || params.get('startapp');
                    if(sharedId) {
                        const target = stories.find(s => s.id === sharedId);
                        if(target) {
                            openStory(sharedId);
                        }
                    }
                    initialUrlCheckDone = true;
                }
            }, err => {
                console.error("Story load error:", err);
                removeLoader();
            });
        }

        function removeLoader() {
            const loader = document.getElementById('loading-screen');
            if(loader) loader.classList.add('hidden');
        }

        function updateAppMeta() {
            const titleTag = document.getElementById('app-title-tag');
            const navTitle = document.getElementById('app-nav-title');
            const setAppName = document.getElementById('set-app-name');
            const setAdLink = document.getElementById('set-ad-link');

            if(titleTag && appSettings.name) titleTag.innerText = appSettings.name;
            if(navTitle && appSettings.name) navTitle.innerText = appSettings.name;
            if(setAppName) setAppName.value = appSettings.name || "";
            if(setAdLink) setAdLink.value = appSettings.adLink || "";
        }

        // --- DIRECT LINK TRIGGER HELPER (For Pagination Only) ---
        function triggerDirectLinkAd() {
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡ßá‡¶ú‡¶ø‡¶®‡ßá‡¶∂‡¶® ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ú‡¶æ‡ßü‡¶ó‡¶æ‡ßü Direct Link ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶π‡¶¨‡ßá
            if(appSettings.adLink && appSettings.adLink.startsWith('http')) {
                window.open(appSettings.adLink, '_blank');
            }
        }

        function acceptAgeGate() {
            localStorage.setItem('age_verified', 'true');
            document.getElementById('age-gate').classList.add('hidden');
        }

        // --- AUTHENTICATION ---
        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;

            try {
                await auth.signInWithEmailAndPassword(email, pass);
                document.getElementById('auth-modal').classList.add('hidden');
                if(email === ADMIN_EMAIL) {
                    showScreen('admin-panel');
                    renderAdminListUI();
                } else {
                    alert("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§");
                    auth.signOut();
                }
            } catch(err) {
                alert("‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•! ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡•§");
            }
        }

        function handleProfileClick() {
            if(currentUser && currentUser.email === ADMIN_EMAIL) {
                showScreen('admin-panel');
                renderAdminListUI();
            } else {
                document.getElementById('auth-modal').classList.remove('hidden');
            }
        }

        function logoutAdmin() {
            auth.signOut().then(() => showScreen('home-screen'));
        }

        // --- FAVORITE FUNCTIONALITY ---
        function getFavorites() {
            return JSON.parse(localStorage.getItem('favStories')) || [];
        }

        function toggleFavorite(e, id) {
            e.stopPropagation(); 
            let favs = getFavorites();

            if(favs.includes(id)) {
                favs = favs.filter(f => f !== id);
            } else {
                favs.push(id);
            }

            localStorage.setItem('favStories', JSON.stringify(favs));
            applyFilters();
        }

        function toggleReadScreenFavorite() {
            if(!currentStoryId) return;
            let favs = getFavorites();
            if(favs.includes(currentStoryId)) {
                favs = favs.filter(f => f !== currentStoryId);
            } else {
                favs.push(currentStoryId);
            }
            localStorage.setItem('favStories', JSON.stringify(favs));
            document.getElementById('read-fav-btn').innerText = favs.includes(currentStoryId) ? '‚ù§Ô∏è' : 'ü§ç';
        }

        // --- FILTERING & PAGINATION ---
        function applyFilters(categoryOverride = null) {
            let searchQuery = document.getElementById('search-input').value.trim().toLowerCase();
            const activeCatBtn = document.querySelector('#category-filters .bg-blue-600');
            const activeFavBtn = document.querySelector('#category-filters .bg-pink-600');

            let cat = 'ALL';
            if (categoryOverride) {
                cat = categoryOverride;
            } else if (activeFavBtn) {
                cat = 'FAVORITES';
            } else if (activeCatBtn) {
                cat = activeCatBtn.innerText;
            }

            let filtered = stories;

            // 1. Filter by Category
            if(cat === 'FAVORITES') {
                const favIds = getFavorites();
                filtered = stories.filter(s => favIds.includes(s.id));
            } else if (cat !== 'ALL' && cat !== '‡¶∏‡¶¨') {
                filtered = stories.filter(s => s.category === cat);
            }

            // 2. Filter by Search
            if(searchQuery) {
                filtered = filtered.filter(s => 
                    (s.title && s.title.toLowerCase().includes(searchQuery)) || 
                    (s.author && s.author.toLowerCase().includes(searchQuery))
                );
            }

            // 3. Filter only Published
            filtered = filtered.filter(s => s.status === 'Published');

            currentFilteredList = filtered;
            renderPaginatedList();
        }

        function handleSearch() {
            currentPage = 1;
            applyFilters();
        }

        function filterByCat(cat) {
            currentPage = 1; 
            const btns = document.querySelectorAll('#category-filters button');
            btns.forEach(b => {
                b.className = "px-5 py-1.5 bg-white text-gray-800 border rounded-full text-sm whitespace-nowrap shadow-sm hover:bg-gray-50 transition";
            });

            if(event && event.target) {
                 if(cat === 'FAVORITES') {
                    event.target.className = "px-5 py-1.5 bg-pink-600 text-white border rounded-full text-sm whitespace-nowrap shadow-sm font-bold transition";
                 } else {
                    event.target.className = "px-5 py-1.5 bg-blue-600 text-white border rounded-full text-sm whitespace-nowrap shadow-sm font-bold transition";
                 }
            }
            applyFilters(cat);
        }

        function changePage(page) {
            const totalPages = Math.ceil(currentFilteredList.length / itemsPerPage);
            if(page < 1 || page > totalPages) return;
            
            // AD TRIGGER: Next page uses Direct Link Popup (Legacy)
            triggerDirectLinkAd();

            currentPage = page;
            renderPaginatedList();
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function renderPaginatedList() {
            const list = document.getElementById('stories-list');
            const noData = document.getElementById('no-data-msg');
            const paginationContainer = document.getElementById('pagination-container');

            if(currentFilteredList.length === 0) {
                list.innerHTML = '';
                noData.classList.remove('hidden');
                paginationContainer.innerHTML = '';
                return;
            }
            noData.classList.add('hidden');

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = currentFilteredList.slice(startIndex, endIndex);

            const favs = getFavorites();
            list.innerHTML = pageData.map(s => {
                const isFav = favs.includes(s.id);
                return `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 card active:scale-[0.98] transition-transform cursor-pointer relative hover:shadow-md" onclick="openStory('${s.id}')">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-white bg-blue-500 px-2 py-0.5 rounded-full">${s.category || '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø'}</span>
                        <div class="flex items-center gap-3">
                             <div class="flex items-center gap-1">
                                <span class="text-[10px] text-gray-400">üëÅÔ∏è ${s.views || 0}</span>
                            </div>
                            <button id="fav-btn-${s.id}" onclick="toggleFavorite(event, '${s.id}')" class="z-10 text-xl hover:scale-110 transition-transform">
                                ${isFav ? '‚ù§Ô∏è' : 'ü§ç'}
                            </button>
                        </div>
                    </div>
                    <h3 class="font-bold text-lg leading-tight mb-2 text-gray-800 dark:text-gray-100 pr-4">${s.title}</h3>
                    <p class="text-gray-500 text-sm line-clamp-2">${s.summary || '‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶™‡ßú‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®...'}</p>
                    <div class="mt-2 text-xs text-gray-400 text-right">‡¶≤‡ßá‡¶ñ‡¶ï: ${s.author}</div>
                </div>
            `}).join('');

            renderPaginationUI();
        }

        function renderPaginationUI() {
            const container = document.getElementById('pagination-container');
            const totalPages = Math.ceil(currentFilteredList.length / itemsPerPage);

            if(totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = `<button onclick="changePage(${currentPage - 1})" class="page-btn ${currentPage === 1 ? 'inactive disabled opacity-50' : 'inactive'}" ${currentPage === 1 ? 'disabled' : ''}>‚Üê</button>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<button onclick="changePage(${i})" class="page-btn ${i === currentPage ? 'active' : 'inactive'}">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<span class="px-1 text-gray-400">...</span>`;
                }
            }

            html += `<button onclick="changePage(${currentPage + 1})" class="page-btn ${currentPage === totalPages ? 'inactive disabled opacity-50' : 'inactive'}" ${currentPage === totalPages ? 'disabled' : ''}>‚Üí</button>`;
            container.innerHTML = html;
        }

        // --- UI RENDERING ---
        function renderCategoriesUI() {
            const filterDiv = document.getElementById('category-filters');
            const select = document.getElementById('story-category-select');
            const adminCatList = document.getElementById('admin-cat-list');

            if(!filterDiv) return;

            // Filters
            let filtersHtml = `
                <button onclick="filterByCat('ALL')" class="px-5 py-1.5 bg-blue-600 text-white border rounded-full text-sm whitespace-nowrap shadow-sm font-bold transition">‡¶∏‡¶¨</button>
                <button onclick="filterByCat('FAVORITES')" class="px-5 py-1.5 bg-white text-gray-800 border rounded-full text-sm whitespace-nowrap shadow-sm hover:bg-gray-50 transition text-pink-600">‚ù§Ô∏è ‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü</button>
            `;
            filtersHtml += categories.map(c => `
                <button onclick="filterByCat('${c}')" class="px-5 py-1.5 bg-white text-gray-800 border rounded-full text-sm whitespace-nowrap shadow-sm hover:bg-gray-50 transition">${c}</button>
            `).join('');
            filterDiv.innerHTML = filtersHtml;

            // Select Dropdown
            if(select) {
                select.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            }

            // Admin List (Fixed rendering)
            if(adminCatList) {
                adminCatList.innerHTML = categories.map(c => `
                    <span class="bg-gray-100 border px-3 py-1 rounded-full text-xs flex items-center gap-2 text-black mb-1 mr-1">
                        ${c} <button onclick="deleteCategory('${c}')" class="text-red-500 font-bold hover:bg-red-100 rounded-full w-5 h-5 flex items-center justify-center">√ó</button>
                    </span>
                `).join('');
            }
        }

        function renderAdminListUI() {
            const list = document.getElementById('admin-story-list');
            if(!list) return;

            list.innerHTML = stories.map(s => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded border">
                    <div>
                        <h4 class="font-bold text-sm text-gray-800">${s.title}</h4>
                        <span class="text-xs text-gray-500">${s.status} ‚Ä¢ üëÅÔ∏è ${s.views || 0}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editStory('${s.id}')" class="text-blue-600 font-bold text-sm hover:underline">Edit</button>
                        <button onclick="deleteStory('${s.id}')" class="text-red-600 font-bold text-sm hover:underline">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // --- STORY LOGIC (UPDATED WITH MONETAG SDK) ---
        function openStory(id) {
            const s = stories.find(x => x.id === id);
            if(!s) return;

            // 1. MONETAG SDK POPUP TRIGGER
            if (typeof show_10366901 === 'function') {
                show_10366901('pop').then(() => {
                    // Ad finished or closed
                }).catch(e => {
                    console.log("Ad Error:", e);
                });
            } else {
                // Fallback: Use Direct Link if SDK fails
                triggerDirectLinkAd();
            }

            currentStoryId = id; 
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + id;
            window.history.pushState({path: newUrl}, '', newUrl);

            // Increase View Count (Only if not admin)
            if(!currentUser || currentUser.email !== ADMIN_EMAIL) {
                db.collection('stories').doc(id).update({
                    views: firebase.firestore.FieldValue.increment(1)
                }).catch(err => console.log("View update err", err));
            }

            document.getElementById('read-title').innerText = s.title;
            document.getElementById('read-meta-author').innerText = `‡¶≤‡ßá‡¶ñ‡¶ï: ${s.author}`;
            document.getElementById('read-meta-cat').innerText = s.category;
            document.getElementById('read-meta-views').innerText = `üëÅÔ∏è ${s.views ? s.views + 1 : 1}`;

            const favs = getFavorites();
            document.getElementById('read-fav-btn').innerText = favs.includes(id) ? '‚ù§Ô∏è' : 'ü§ç';

            // --- 2. In-Article Ad Banner Logic (Kept as requested) ---
            const contentEl = document.getElementById('read-content');
            contentEl.innerHTML = ""; // Clear existing

            const fullText = s.content;
            const middleIndex = Math.floor(fullText.length / 2);
            // Find nearest newline to avoid splitting sentences
            const splitIndex = fullText.indexOf('\n', middleIndex);

            let part1 = fullText;
            let part2 = "";

            if (splitIndex !== -1) {
                part1 = fullText.substring(0, splitIndex);
                part2 = fullText.substring(splitIndex);
            }

            // Render Part 1
            const div1 = document.createElement('div');
            div1.innerText = part1;
            contentEl.appendChild(div1);

            // Render Ad Banner (Middle) - Uses settings Direct Link
            if (appSettings.adLink && part2) {
                const adDiv = document.createElement('div');
                adDiv.className = "my-8 p-4 bg-red-50 border border-red-100 rounded-xl text-center shadow-sm";
                adDiv.innerHTML = `
                    <p class="text-[10px] text-gray-400 mb-2 tracking-widest">SPONSORED</p>
                    <a href="${appSettings.adLink}" target="_blank" class="inline-block bg-gradient-to-r from-red-600 to-pink-600 text-white px-8 py-3 rounded-full font-bold shadow-lg animate-pulse hover:scale-105 transition-transform">
                        üîû ‡ßß‡ßÆ+ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
                    </a>
                `;
                contentEl.appendChild(adDiv);
            }

            // Render Part 2
            const div2 = document.createElement('div');
            div2.innerText = part2;
            contentEl.appendChild(div2);

            contentEl.style.fontSize = currentFontSize + 'px';
            contentEl.style.lineHeight = (currentFontSize + 12) + 'px';

            showScreen('reading-screen');
        }

        function closeReadingScreen() {
            showScreen('home-screen');
            currentStoryId = null;
            const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.pushState({path: cleanUrl}, '', cleanUrl);
        }

        function changeFontSize(action) {
            const content = document.getElementById('read-content');
            if(!content) return;

            if (action === 'increase') {
                if(currentFontSize < 34) currentFontSize += 2;
            } else if (action === 'decrease') {
                if(currentFontSize > 12) currentFontSize -= 2;
            }
            content.style.fontSize = currentFontSize + 'px';
            content.style.lineHeight = (currentFontSize + 12) + 'px';
        }

        function shareStory() {
            if(!currentStoryId) return;

            const botUsername = "Bangalchotigolpo_bot"; 
            const miniAppName = "Bangalchotigolpo";

            const title = document.getElementById('read-title').innerText;
            const shareUrl = `https://t.me/${botUsername}/${miniAppName}?startapp=${currentStoryId}`;
            const shareText = `üî• ‡¶¶‡¶æ‡¶∞‡ßÅ‡¶£ ‡¶ó‡¶≤‡ßç‡¶™: "${title}"\n\n‡¶™‡ßÅ‡¶∞‡ßã‡¶ü‡¶æ ‡¶™‡ßú‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® üëá\n${shareUrl}`;

            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: shareText
                }).catch(err => console.log('Share error', err));
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert("‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                }).catch(() => {
                    prompt("‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶ø ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®:", shareText);
                });
            }
        }

        // --- ADMIN FUNCTIONS ---
        async function updateSettings() {
            const name = document.getElementById('set-app-name').value;
            const link = document.getElementById('set-ad-link').value;
            try {
                await db.collection('config').doc('app_settings').set({ name, adLink: link }, { merge: true });
                alert("‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            } catch(e) { alert("Error: " + e.message); }
        }

        async function addCategory() {
            const val = document.getElementById('new-cat-input').value.trim();
            if(!val) return;
            
            // Check duplicates in current list
            if(categories.includes(val)) { 
                alert("‡¶è‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶Ü‡¶õ‡ßá!"); 
                return; 
            }

            try {
                const newList = [...categories, val];
                // Update Firestore
                await db.collection('config').doc('categories').set({ list: newList });
                document.getElementById('new-cat-input').value = "";
            } catch(e) { 
                console.error(e);
                alert("Error updating category: " + e.message); 
            }
        }

        async function deleteCategory(catName) {
            if(confirm(`'${catName}' ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`)) {
                try {
                    const newList = categories.filter(c => c !== catName);
                    await db.collection('config').doc('categories').set({ list: newList });
                } catch(e) {
                    alert("Error deleting category: " + e.message);
                }
            }
        }

        const storyForm = document.getElementById('story-form');
        if(storyForm) {
            storyForm.onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-id').value;
                const data = {
                    title: document.getElementById('story-title').value,
                    author: document.getElementById('story-author').value,
                    category: document.getElementById('story-category-select').value,
                    summary: document.getElementById('story-summary').value,
                    content: document.getElementById('story-content').value,
                    status: document.getElementById('story-status').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if(!id) data.views = 0;

                try {
                    id ? await db.collection('stories').doc(id).update(data) : await db.collection('stories').add(data);
                    resetForm();
                    alert("‡¶ó‡¶≤‡ßç‡¶™ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                    showScreen('admin-panel'); 
                } catch(err) { alert("Error: " + err.message); }
            };
        }

        function resetForm() {
            document.getElementById('story-form').reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('form-mode-title').innerText = "‡¶ó‡¶≤‡ßç‡¶™ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®";
        }

        function editStory(id) {
            const s = stories.find(x => x.id === id);
            if(!s) return;
            document.getElementById('edit-id').value = s.id;
            document.getElementById('story-title').value = s.title;
            document.getElementById('story-author').value = s.author;
            document.getElementById('story-category-select').value = s.category;
            document.getElementById('story-summary').value = s.summary || "";
            document.getElementById('story-content').value = s.content;
            document.getElementById('story-status').value = s.status;
            document.getElementById('form-mode-title').innerText = "‡¶ó‡¶≤‡ßç‡¶™ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶õ‡ßá‡¶®";
            document.getElementById('story-form').scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteStory(id) {
            if(confirm("‡¶∏‡¶§‡ßç‡¶Ø‡¶ø‡¶á ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                await db.collection('stories').doc(id).delete();
            }
        }

        // --- UTILS ---
        function showScreen(id) {
            ['home-screen', 'reading-screen', 'admin-panel'].forEach(s => {
                const el = document.getElementById(s);
                if(el) el.classList.add('hidden');
            });
            const target = document.getElementById(id);
            if(target) target.classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            localStorage.setItem('nightMode', document.body.classList.contains('night-mode'));
        }
    </script>
</body>
</html>