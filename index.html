<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title-tag">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶ö‡¶ü‡¶ø ‡¶ó‡¶≤‡ßç‡¶™</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK (Version 8 compatible) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Night Mode Styles */
        body.night-mode {
            background-color: #0f172a;
            color: #e2e8f0;
        }
        
        .night-mode .bg-white { background-color: #1e293b; }
        .night-mode .text-gray-800 { color: #f1f5f9; }
        .night-mode .text-gray-500 { color: #94a3b8; }
        .night-mode .border-gray-100 { border-color: #334155; }
        .night-mode .bg-gray-50 { background-color: #334155; }
        .night-mode .hover\:bg-gray-50:hover { background-color: #475569; }

        .hidden { display: none !important; }
        
        /* Loader Animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Scrollbar Hide */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Pagination Button Styles */
        .page-btn {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .page-btn.active {
            background-color: #2563eb;
            color: white;
            border: none;
        }
        .page-btn.inactive {
            background-color: white;
            border: 1px solid #e2e8f0;
            color: #1e293b;
        }
        .night-mode .page-btn.inactive {
            background-color: #1e293b;
            border-color: #334155;
            color: #e2e8f0;
        }
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-gray-500 animate-pulse">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>

    <!-- Age Verification Modal -->
    <div id="age-gate" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-5">
        <div class="bg-white p-8 rounded-2xl max-w-sm text-center">
            <h2 class="text-2xl font-bold text-red-600 mb-4">‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡ßÄ‡¶ï‡¶∞‡¶£ (18+)</h2>
            <p class="text-gray-600 mb-6">‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∑‡ßü‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶¨‡ßü‡¶∏‡ßç‡¶ï‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßü‡¶∏ ‡¶ï‡¶ø ‡ßß‡ßÆ ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø?</p>
            <button onclick="acceptAgeGate()" class="bg-red-600 text-white px-8 py-3 rounded-full font-bold w-full hover:bg-red-700">‡¶π‡ßç‡¶Ø‡¶æ‡¶Å, ‡¶Ü‡¶Æ‡¶ø ‡ßß‡ßÆ+</button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-5 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm relative">
            <button onclick="document.getElementById('auth-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 text-xl">√ó</button>
            <h3 class="text-xl font-bold mb-4 text-center text-gray-800">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ó‡¶á‡¶®</h3>
            <form onsubmit="handleAuth(event)" class="space-y-4">
                <input type="email" id="auth-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤" class="w-full p-3 border rounded-lg bg-gray-50 focus:outline-none focus:border-blue-500 text-gray-800">
                <input type="password" id="auth-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" class="w-full p-3 border rounded-lg bg-gray-50 focus:outline-none focus:border-blue-500 text-gray-800">
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">‡¶≤‡¶ó‡¶á‡¶®</button>
            </form>
        </div>
    </div>

    <!-- ================= HOME SCREEN ================= -->
    <div id="home-screen">
        <!-- Header -->
        <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-gray-100 px-4 py-3 flex justify-between items-center">
            <h1 id="app-nav-title" class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶ö‡¶ü‡¶ø ‡¶ó‡¶≤‡ßç‡¶™</h1>
            <div class="flex items-center gap-3">
                <button onclick="toggleNightMode()" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200">üåô</button>
                <button onclick="handleProfileClick()" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200">üë§</button>
            </div>
        </header>

        <!-- Search & Filter -->
        <div class="p-4 space-y-4">
            <input type="text" id="search-input" onkeyup="handleSearch()" placeholder="‡¶ó‡¶≤‡ßç‡¶™ ‡¶¨‡¶æ ‡¶≤‡ßá‡¶ñ‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full p-3 rounded-xl border border-gray-200 bg-white shadow-sm focus:outline-none focus:border-blue-500 text-gray-800">
            
            <div id="category-filters" class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                <!-- Categories will be injected here -->
            </div>
        </div>

        <!-- Stories List -->
        <div id="stories-list" class="px-4 space-y-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Stories will be injected here -->
        </div>

        <!-- No Data Message -->
        <div id="no-data-msg" class="hidden text-center py-20 text-gray-400">
            ‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡¶≤‡ßç‡¶™ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø üòû
        </div>

        <!-- Pagination Controls (NEW) -->
        <div id="pagination-container" class="py-8 flex justify-center items-center gap-2 flex-wrap px-4 pb-20">
            <!-- Pagination injected by JS -->
        </div>

        <!-- Admin Access Float Button (Visible only to Admin) -->
        <button id="admin-indicator" onclick="showScreen('admin-panel'); renderAdminListUI();" class="hidden fixed bottom-6 right-6 bg-purple-600 text-white p-4 rounded-full shadow-lg font-bold z-30">
            ‚öôÔ∏è ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤
        </button>
    </div>

    <!-- ================= READING SCREEN ================= -->
    <div id="reading-screen" class="hidden min-h-screen bg-white pb-20">
        <!-- Reading Header with Font Controls -->
        <div class="sticky top-0 bg-white/95 backdrop-blur border-b p-3 flex justify-between items-center z-10 shadow-sm">
            <button onclick="closeReadingScreen()" class="text-blue-600 font-bold px-2 py-1 flex items-center gap-1">
                <span>‚Üê</span> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®
            </button>
            
            <div class="flex items-center gap-2">
                <button id="read-fav-btn" onclick="toggleReadScreenFavorite()" class="p-2 text-xl border rounded bg-gray-50 mr-2">ü§ç</button>
                <span class="text-xs text-gray-400 mr-1">‡¶´‡¶®‡ßç‡¶ü:</span>
                <button onclick="changeFontSize('decrease')" class="bg-gray-100 border px-3 py-1 rounded text-sm font-bold active:bg-gray-200 text-black">A-</button>
                <button onclick="changeFontSize('increase')" class="bg-gray-100 border px-3 py-1 rounded text-sm font-bold active:bg-gray-200 text-black">A+</button>
            </div>
        </div>
    
        <div class="p-5 max-w-3xl mx-auto">
            <h1 id="read-title" class="text-2xl md:text-3xl font-bold mb-3 text-gray-900 leading-snug">‡¶ó‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</h1>
            
            <div class="flex flex-wrap justify-between items-center text-sm text-gray-500 mb-6 border-b pb-4 gap-2">
                <div class="flex gap-3">
                    <span id="read-meta-author" class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded">‡¶≤‡ßá‡¶ñ‡¶ï</span> 
                    <span id="read-meta-cat" class="bg-gray-100 px-2 py-0.5 rounded">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</span>
                </div>
                <div id="read-meta-views" class="flex items-center gap-1 font-medium">üëÅÔ∏è 0</div>
            </div>
    
            <div id="read-content" class="text-gray-800 leading-relaxed whitespace-pre-wrap font-medium" style="font-size: 18px;">
                ‡¶ó‡¶≤‡ßç‡¶™ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
            </div>
    
            <div class="mt-12 pt-6 border-t border-gray-100">
                <button onclick="shareStory()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3.5 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2 transition-transform active:scale-95">
                    <span>üîó</span> ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>

    <!-- ================= ADMIN PANEL ================= -->
    <div id="admin-panel" class="hidden min-h-screen bg-gray-50 pb-20">
        <div class="bg-white p-4 shadow-sm flex justify-between items-center sticky top-0 z-20">
            <h2 class="text-xl font-bold text-gray-800">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
            <div class="flex gap-2">
                <button onclick="showScreen('home-screen')" class="px-4 py-2 bg-gray-200 rounded-lg text-sm text-black">‡¶π‡ßã‡¶Æ</button>
                <button onclick="logoutAdmin()" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg text-sm font-bold">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
            </div>
        </div>

        <div class="p-4 max-w-4xl mx-auto space-y-6">
            <!-- Settings Card -->
            <div class="bg-white p-5 rounded-xl shadow-sm border">
                <h3 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2">‚öôÔ∏è ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
                <div class="grid gap-4 md:grid-cols-2">
                    <input id="set-app-name" type="text" placeholder="‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="p-2 border rounded text-black">
                    <input id="set-ad-link" type="text" placeholder="Adsterra Direct Link" class="p-2 border rounded text-black">
                </div>
                <button onclick="updateSettings()" class="mt-4 bg-gray-800 text-white px-6 py-2 rounded-lg text-sm">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>

            <!-- Category Management -->
            <div class="bg-white p-5 rounded-xl shadow-sm border">
                <h3 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2">üìÇ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
                <div class="flex gap-2 mb-4">
                    <input id="new-cat-input" type="text" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶æ‡¶Æ" class="flex-1 p-2 border rounded text-black">
                    <button onclick="addCategory()" class="bg-green-600 text-white px-4 rounded font-bold">+</button>
                </div>
                <div id="admin-cat-list" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Story Form -->
            <div class="bg-white p-5 rounded-xl shadow-sm border">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 id="form-mode-title" class="font-bold text-lg text-gray-800">üìù ‡¶ó‡¶≤‡ßç‡¶™ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</h3>
                    <button onclick="resetForm()" class="text-xs text-blue-600 underline">‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button>
                </div>
                
                <form id="story-form" class="space-y-4">
                    <input type="hidden" id="edit-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="story-title" required type="text" placeholder="‡¶ó‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="p-3 border rounded text-black w-full">
                        <input id="story-author" required type="text" placeholder="‡¶≤‡ßá‡¶ñ‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="p-3 border rounded text-black w-full">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <select id="story-category-select" class="p-3 border rounded bg-white text-black w-full"></select>
                        <select id="story-status" class="p-3 border rounded bg-white text-black w-full">
                            <option value="Published">Published</option>
                            <option value="Draft">Draft</option>
                        </select>
                    </div>

                    <textarea id="story-summary" rows="2" placeholder="‡¶õ‡ßã‡¶ü ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™ (Summary)" class="w-full p-3 border rounded text-black"></textarea>
                    <textarea id="story-content" required rows="10" placeholder="‡¶Æ‡ßÇ‡¶≤ ‡¶ó‡¶≤‡ßç‡¶™ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="w-full p-3 border rounded text-black"></textarea>

                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </form>
            </div>

            <!-- Admin Story List (Edit/Delete) -->
            <div class="bg-white p-5 rounded-xl shadow-sm border">
                <h3 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2">‡¶∏‡¶¨ ‡¶ó‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
                <div id="admin-story-list" class="space-y-3">
                    <!-- List injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONFIGURATION ---
        const ADMIN_EMAIL = "bcg332006@gmail.com";
        const DEFAULT_CATS = ['‡¶∞‡ßã‡¶Æ‡¶æ‡¶®‡ßç‡¶ü‡¶ø‡¶ï', '‡¶™‡¶∞‡¶ï‡ßÄ‡ßü‡¶æ', '‡¶á‡¶®‡¶∏‡ßá‡¶∏‡ßç‡¶ü', '‡¶≠‡¶æ‡¶¨‡¶ø', '‡¶≤‡ßá‡¶∏‡¶¨‡¶ø‡ßü‡¶æ‡¶®', '‡¶´‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü‡¶æ‡¶∏‡¶ø', '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø'];

        const firebaseConfig = {
            apiKey: "AIzaSyA4gqOdRYydzPOR7a8brxBy2Bs49MtVqJw",
            authDomain: "bangla-f8386.firebaseapp.com",
            projectId: "bangla-f8386",
            storageBucket: "bangla-f8386.firebasestorage.app",
            messagingSenderId: "213257434534",
            appId: "1:213257434534:web:3748a963d1f4e299e64b67"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // State Variables
        let appSettings = { name: "‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶ö‡¶ü‡¶ø ‡¶ó‡¶≤‡ßç‡¶™", adLink: "https://otieu.com/4/10189186" };
        let categories = [...DEFAULT_CATS]; 
        let stories = [];
        let currentUser = null;
        let currentFontSize = 18; 
        let currentStoryId = null; 
        let initialUrlCheckDone = false; 

        // --- PAGINATION VARIABLES ---
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentFilteredList = []; // This holds the list after search/category filter

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            // Check Age Gate
            if(!localStorage.getItem('age_verified')) {
                document.getElementById('age-gate').classList.remove('hidden');
            }

            // Initial Render
            renderCategoriesUI();

            // Check Night Mode
            if(localStorage.getItem('nightMode') === 'true') {
                document.body.classList.add('night-mode');
            }

            // Auth Listener
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if(user && user.email === ADMIN_EMAIL) {
                    document.getElementById('admin-indicator').classList.remove('hidden');
                } else {
                    document.getElementById('admin-indicator').classList.add('hidden');
                }
            });

            // Load Settings
            db.collection('config').doc('app_settings').onSnapshot(doc => {
                if(doc.exists) {
                    appSettings = doc.data();
                    updateAppMeta();
                }
                removeLoader();
            }, err => removeLoader());

            // Load Categories
            db.collection('config').doc('categories').onSnapshot(doc => {
                if(doc.exists && doc.data().list && doc.data().list.length > 0) {
                    categories = doc.data().list;
                } else {
                    categories = [...DEFAULT_CATS];
                }
                renderCategoriesUI();
            });

            // Load Stories
            db.collection('stories').orderBy('updatedAt', 'desc').onSnapshot(snap => {
                stories = snap.docs.map(d => ({id: d.id, ...d.data()}));
                
                // On initial load, set current list to all stories
                applyFilters(); 
                
                if(currentUser && currentUser.email === ADMIN_EMAIL) renderAdminListUI();

                // Check URL for shared story ID
                if (!initialUrlCheckDone && stories.length > 0) {
                    const params = new URLSearchParams(window.location.search);
                    const sharedId = params.get('id');
                    if(sharedId) {
                        const target = stories.find(s => s.id === sharedId);
                        if(target) {
                            openStory(sharedId);
                        }
                    }
                    initialUrlCheckDone = true;
                }
            });
        }

        function removeLoader() {
            const loader = document.getElementById('loading-screen');
            if(loader) loader.classList.add('hidden');
        }

        function updateAppMeta() {
            const titleTag = document.getElementById('app-title-tag');
            const navTitle = document.getElementById('app-nav-title');
            const setAppName = document.getElementById('set-app-name');
            const setAdLink = document.getElementById('set-ad-link');

            if(titleTag) titleTag.innerText = appSettings.name;
            if(navTitle) navTitle.innerText = appSettings.name;
            if(setAppName) setAppName.value = appSettings.name;
            if(setAdLink) setAdLink.value = appSettings.adLink;
        }

        function acceptAgeGate() {
            localStorage.setItem('age_verified', 'true');
            document.getElementById('age-gate').classList.add('hidden');
            if(appSettings.adLink) window.open(appSettings.adLink, '_blank');
        }

        // --- AUTHENTICATION ---
        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, pass);
                document.getElementById('auth-modal').classList.add('hidden');
                if(email === ADMIN_EMAIL) {
                    showScreen('admin-panel');
                    renderAdminListUI();
                } else {
                    alert("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§");
                    auth.signOut();
                }
            } catch(err) {
                alert("‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•! ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡•§");
            }
        }

        function handleProfileClick() {
            if(currentUser && currentUser.email === ADMIN_EMAIL) {
                showScreen('admin-panel');
                renderAdminListUI();
            } else {
                document.getElementById('auth-modal').classList.remove('hidden');
            }
        }

        function logoutAdmin() {
            auth.signOut().then(() => showScreen('home-screen'));
        }

        // --- FAVORITE FUNCTIONALITY ---
        function getFavorites() {
            return JSON.parse(localStorage.getItem('favStories')) || [];
        }

        function toggleFavorite(e, id) {
            e.stopPropagation(); 
            let favs = getFavorites();
            
            if(favs.includes(id)) {
                favs = favs.filter(f => f !== id);
            } else {
                favs.push(id);
            }
            
            localStorage.setItem('favStories', JSON.stringify(favs));
            
            // Update UI Button
            const btn = document.getElementById(`fav-btn-${id}`);
            if(btn) btn.innerText = favs.includes(id) ? '‚ù§Ô∏è' : 'ü§ç';

            // Refresh current view if needed
            // If active tab is favorites, reload the list
            const activeFilter = document.querySelector('#category-filters .bg-pink-600');
            if(activeFilter) {
                filterByCat('FAVORITES');
            }
        }

        function toggleReadScreenFavorite() {
            if(!currentStoryId) return;
            let favs = getFavorites();
            if(favs.includes(currentStoryId)) {
                favs = favs.filter(f => f !== currentStoryId);
            } else {
                favs.push(currentStoryId);
            }
            localStorage.setItem('favStories', JSON.stringify(favs));
            document.getElementById('read-fav-btn').innerText = favs.includes(currentStoryId) ? '‚ù§Ô∏è' : 'ü§ç';
            
            // Update list icon if visible
            const listBtn = document.getElementById(`fav-btn-${currentStoryId}`);
            if(listBtn) listBtn.innerText = favs.includes(currentStoryId) ? '‚ù§Ô∏è' : 'ü§ç';
        }

        // --- FILTERING & PAGINATION LOGIC ---
        
        // Master function to handle data preparation
        function applyFilters(categoryOverride = null) {
            const searchQuery = document.getElementById('search-input').value.toLowerCase().trim();
            const activeCatBtn = document.querySelector('#category-filters .bg-blue-600');
            const activeFavBtn = document.querySelector('#category-filters .bg-pink-600');
            
            let cat = 'ALL';
            if (categoryOverride) {
                cat = categoryOverride;
            } else if (activeFavBtn) {
                cat = 'FAVORITES';
            } else if (activeCatBtn) {
                cat = activeCatBtn.innerText;
            }

            // 1. Filter by Category
            let filtered = stories;
            if(cat === 'FAVORITES') {
                const favIds = getFavorites();
                filtered = stories.filter(s => favIds.includes(s.id));
            } else if (cat !== 'ALL' && cat !== '‡¶∏‡¶¨') {
                filtered = stories.filter(s => s.category === cat);
            }

            // 2. Filter by Search Query
            if(searchQuery) {
                filtered = filtered.filter(s => 
                    s.title.toLowerCase().includes(searchQuery) || 
                    s.author.toLowerCase().includes(searchQuery)
                );
            }
            
            // 3. Filter only Published
            filtered = filtered.filter(s => s.status === 'Published');

            // Update State
            currentFilteredList = filtered;
            
            // If function triggered by user interaction (not initial load), reset to page 1
            // But if called by pagination, we handle that in changePage.
            // Here we assume if applyFilters is called, we reset page unless specified otherwise.
            // For simplicity: Search/Cat change resets page.
            
            renderPaginatedList();
        }

        function handleSearch() {
            currentPage = 1;
            applyFilters();
        }

        function filterByCat(cat) {
            currentPage = 1; // Reset page
            
            // Update Button Styles
            const btns = document.querySelectorAll('#category-filters button');
            btns.forEach(b => {
                b.className = "px-5 py-1.5 bg-white text-gray-800 border rounded-full text-sm whitespace-nowrap shadow-sm hover:bg-gray-50";
            });
            
            // Identify which button was clicked (event target) or find by text
            if(event && event.target) {
                // If clicked via UI
                 if(cat === 'FAVORITES') {
                    event.target.className = "px-5 py-1.5 bg-pink-600 text-white border rounded-full text-sm whitespace-nowrap shadow-sm font-bold";
                 } else {
                    event.target.className = "px-5 py-1.5 bg-blue-600 text-white border rounded-full text-sm whitespace-nowrap shadow-sm font-bold";
                 }
            } else {
                // Initial load or manual trigger - find the button
                 // Skip complex DOM finding for now, basic logic works
            }

            applyFilters(cat);
        }

        function changePage(page) {
            if(page < 1 || page > Math.ceil(currentFilteredList.length / itemsPerPage)) return;
            currentPage = page;
            renderPaginatedList();
            
            // Scroll to top of list
            const container = document.getElementById('stories-list');
            const offset = container.getBoundingClientRect().top + window.scrollY - 80;
            window.scrollTo({top: offset, behavior: 'smooth'});
        }

        function renderPaginatedList() {
            const list = document.getElementById('stories-list');
            const noData = document.getElementById('no-data-msg');
            const paginationContainer = document.getElementById('pagination-container');

            if(currentFilteredList.length === 0) {
                list.innerHTML = '';
                noData.classList.remove('hidden');
                paginationContainer.innerHTML = '';
                return;
            }
            noData.classList.add('hidden');

            // Calculate Slice
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = currentFilteredList.slice(startIndex, endIndex);

            // Render List
            const favs = getFavorites();
            list.innerHTML = pageData.map(s => {
                const isFav = favs.includes(s.id);
                return `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 card active:scale-[0.98] transition-transform cursor-pointer relative" onclick="openStory('${s.id}')">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-white bg-blue-500 px-2 py-0.5 rounded-full">${s.category}</span>
                        <div class="flex items-center gap-3">
                             <div class="flex items-center gap-1">
                                <span class="text-[10px] text-gray-400">üëÅÔ∏è ${s.views || 0}</span>
                            </div>
                            <button id="fav-btn-${s.id}" onclick="toggleFavorite(event, '${s.id}')" class="z-10 text-xl hover:scale-110 transition-transform">
                                ${isFav ? '‚ù§Ô∏è' : 'ü§ç'}
                            </button>
                        </div>
                    </div>
                    <h3 class="font-bold text-lg leading-tight mb-2 text-gray-800 dark:text-gray-100 pr-4">${s.title}</h3>
                    <p class="text-gray-500 text-sm line-clamp-2">${s.summary}</p>
                    <div class="mt-2 text-xs text-gray-400 text-right">‡¶≤‡ßá‡¶ñ‡¶ï: ${s.author}</div>
                </div>
            `}).join('');

            // Render Pagination Controls
            renderPaginationUI();
        }

        function renderPaginationUI() {
            const container = document.getElementById('pagination-container');
            const totalPages = Math.ceil(currentFilteredList.length / itemsPerPage);

            if(totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // Previous Button
            html += `<button onclick="changePage(${currentPage - 1})" class="page-btn ${currentPage === 1 ? 'inactive disabled opacity-50' : 'inactive'}" ${currentPage === 1 ? 'disabled' : ''}>‚Üê</button>`;

            // Numbered Buttons (Logic to show simple range)
            for (let i = 1; i <= totalPages; i++) {
                // Show first, last, current, and neighbors
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<button onclick="changePage(${i})" class="page-btn ${i === currentPage ? 'active' : 'inactive'}">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<span class="px-1 text-gray-400">...</span>`;
                }
            }

            // Next Button
            html += `<button onclick="changePage(${currentPage + 1})" class="page-btn ${currentPage === totalPages ? 'inactive disabled opacity-50' : 'inactive'}" ${currentPage === totalPages ? 'disabled' : ''}>‚Üí</button>`;

            container.innerHTML = html;
        }

        // --- UI RENDERING (Categories & Admin) ---
        function renderCategoriesUI() {
            const filterDiv = document.getElementById('category-filters');
            const select = document.getElementById('story-category-select');
            const adminCatList = document.getElementById('admin-cat-list');

            if(!filterDiv) return;

            // Filters
            let filtersHtml = `
                <button onclick="filterByCat('ALL')" class="px-5 py-1.5 bg-blue-600 text-white border rounded-full text-sm whitespace-nowrap shadow-sm font-bold">‡¶∏‡¶¨</button>
                <button onclick="filterByCat('FAVORITES')" class="px-5 py-1.5 bg-white text-gray-800 border rounded-full text-sm whitespace-nowrap shadow-sm hover:bg-gray-50 text-pink-600">‚ù§Ô∏è ‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü</button>
            `;
            filtersHtml += categories.map(c => `
                <button onclick="filterByCat('${c}')" class="px-5 py-1.5 bg-white text-gray-800 border rounded-full text-sm whitespace-nowrap shadow-sm hover:bg-gray-50">${c}</button>
            `).join('');
            filterDiv.innerHTML = filtersHtml;
            
            // Select Dropdown
            if(select) {
                select.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            }
            
            // Admin List
            if(adminCatList) {
                adminCatList.innerHTML = categories.map(c => `
                    <span class="bg-gray-100 border px-3 py-1 rounded-full text-xs flex items-center gap-2 text-black">
                        ${c} <button onclick="deleteCategory('${c}')" class="text-red-500 font-bold hover:bg-red-100 rounded-full w-5 h-5 flex items-center justify-center">√ó</button>
                    </span>
                `).join('');
            }
        }

        function renderAdminListUI() {
            const list = document.getElementById('admin-story-list');
            if(!list) return;
            
            list.innerHTML = stories.map(s => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded border">
                    <div>
                        <h4 class="font-bold text-sm text-gray-800">${s.title}</h4>
                        <span class="text-xs text-gray-500">${s.status} ‚Ä¢ üëÅÔ∏è ${s.views || 0}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editStory('${s.id}')" class="text-blue-600 font-bold text-sm">Edit</button>
                        <button onclick="deleteStory('${s.id}')" class="text-red-600 font-bold text-sm">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // --- STORY LOGIC ---
        function openStory(id) {
            const s = stories.find(x => x.id === id);
            if(!s) return;

            currentStoryId = id; 

            // Update URL
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + id;
            window.history.pushState({path: newUrl}, '', newUrl);

            // Increment View Count
            db.collection('stories').doc(id).update({
                views: firebase.firestore.FieldValue.increment(1)
            }).catch(err => console.log("View update err", err));

            // Set Data
            document.getElementById('read-title').innerText = s.title;
            document.getElementById('read-meta-author').innerText = `‡¶≤‡ßá‡¶ñ‡¶ï: ${s.author}`;
            document.getElementById('read-meta-cat').innerText = s.category;
            
            const currentViews = s.views ? s.views : 0;
            document.getElementById('read-meta-views').innerText = `üëÅÔ∏è ${currentViews + 1}`;

            const favs = getFavorites();
            document.getElementById('read-fav-btn').innerText = favs.includes(id) ? '‚ù§Ô∏è' : 'ü§ç';

            const contentEl = document.getElementById('read-content');
            contentEl.innerText = s.content;
            
            contentEl.style.fontSize = currentFontSize + 'px';
            contentEl.style.lineHeight = (currentFontSize + 12) + 'px';

            showScreen('reading-screen');
        }

        function closeReadingScreen() {
            showScreen('home-screen');
            currentStoryId = null;
            const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.pushState({path: cleanUrl}, '', cleanUrl);
        }

        function changeFontSize(action) {
            const content = document.getElementById('read-content');
            if(!content) return;

            if (action === 'increase') {
                if(currentFontSize < 34) currentFontSize += 2;
            } else if (action === 'decrease') {
                if(currentFontSize > 12) currentFontSize -= 2;
            }
            content.style.fontSize = currentFontSize + 'px';
            content.style.lineHeight = (currentFontSize + 12) + 'px';
        }

        function shareStory() {
            if(!currentStoryId) return;

            const title = document.getElementById('read-title').innerText;
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?id=${currentStoryId}`;
            
            const shareText = `‡¶™‡ßú‡ßÅ‡¶®: "${title}"\n‡¶≤‡¶ø‡¶Ç‡¶ï: ${shareUrl}`;
            
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: `‡¶™‡ßú‡ßÅ‡¶®: "${title}" - ${appSettings.name}`,
                    url: shareUrl
                }).catch(err => console.log('Share closed'));
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert("‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®:\n" + shareUrl);
                }).catch(() => {
                    prompt("‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶ø ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®:", shareUrl);
                });
            }
        }

        // --- ADMIN FUNCTIONS ---
        async function updateSettings() {
            const name = document.getElementById('set-app-name').value;
            const link = document.getElementById('set-ad-link').value;
            try {
                await db.collection('config').doc('app_settings').set({ name, adLink: link });
                alert("‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            } catch(e) { alert("Error: " + e.message); }
        }

        async function addCategory() {
            const val = document.getElementById('new-cat-input').value.trim();
            if(!val) return;
            if(categories.includes(val)) { alert("‡¶è‡¶ü‡¶ø ‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶Ü‡¶õ‡ßá!"); return; }
            try {
                const newList = [...categories, val];
                await db.collection('config').doc('categories').set({ list: newList });
                document.getElementById('new-cat-input').value = "";
            } catch(e) { alert("Error updating category"); }
        }

        async function deleteCategory(catName) {
            if(confirm(`'${catName}' ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`)) {
                const newList = categories.filter(c => c !== catName);
                await db.collection('config').doc('categories').set({ list: newList });
            }
        }

        const storyForm = document.getElementById('story-form');
        if(storyForm) {
            storyForm.onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-id').value;
                const data = {
                    title: document.getElementById('story-title').value,
                    author: document.getElementById('story-author').value,
                    category: document.getElementById('story-category-select').value,
                    summary: document.getElementById('story-summary').value,
                    content: document.getElementById('story-content').value,
                    status: document.getElementById('story-status').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if(!id) {
                    data.views = 0;
                }

                try {
                    id ? await db.collection('stories').doc(id).update(data) : await db.collection('stories').add(data);
                    resetForm();
                    alert("‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                } catch(err) { alert("Error: " + err.message); }
            };
        }

        function resetForm() {
            document.getElementById('story-form').reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('form-mode-title').innerText = "‡¶ó‡¶≤‡ßç‡¶™ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®";
        }

        function editStory(id) {
            const s = stories.find(x => x.id === id);
            document.getElementById('edit-id').value = s.id;
            document.getElementById('story-title').value = s.title;
            document.getElementById('story-author').value = s.author;
            document.getElementById('story-category-select').value = s.category;
            document.getElementById('story-summary').value = s.summary;
            document.getElementById('story-content').value = s.content;
            document.getElementById('story-status').value = s.status;
            document.getElementById('form-mode-title').innerText = "‡¶ó‡¶≤‡ßç‡¶™ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶õ‡ßá‡¶®";
            showScreen('admin-panel');
        }

        async function deleteStory(id) {
            if(confirm("‡¶∏‡¶§‡ßç‡¶Ø‡¶ø‡¶á ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) await db.collection('stories').doc(id).delete();
        }

        // --- UTILS ---
        function showScreen(id) {
            ['home-screen', 'reading-screen', 'admin-panel'].forEach(s => {
                const el = document.getElementById(s);
                if(el) el.classList.add('hidden');
            });
            const target = document.getElementById(id);
            if(target) target.classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            localStorage.setItem('nightMode', document.body.classList.contains('night-mode'));
        }
    </script>
</body>
</html>